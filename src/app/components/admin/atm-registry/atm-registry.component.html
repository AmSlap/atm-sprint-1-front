<div class="atm-registry-container">
  <!-- Enhanced Header Section -->
  <div class="registry-header">
    <div class="header-content">
      <div class="header-icon">🏛️</div>
      <div class="header-text">
        <h1>ATM Registry Management</h1>
        <p class="header-subtitle">Register and manage ATM devices and configurations</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="last-updated">
        <div class="update-label">Last Updated</div>
        <div class="update-time">{{ getCurrentTime() }}</div>
        <div class="update-user">by {{ getCurrentUser() }}</div>
      </div>
      <button class="btn btn-outline" (click)="refreshAtms()" [disabled]="loading">
        <span class="btn-icon" [ngClass]="{'spinning': loading}">🔄</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="message-container">
    <div *ngIf="successMessage" class="message success">
      <span class="message-icon">✅</span>
      <span class="message-text">{{ successMessage }}</span>
      <button class="message-close" (click)="clearSuccessMessage()">✖</button>
    </div>

    <div *ngIf="errorMessage" class="message error">
      <span class="message-icon">❌</span>
      <span class="message-text">{{ errorMessage }}</span>
      <button class="message-close" (click)="clearErrorMessage()">✖</button>
    </div>
  </div>

  <div class="registry-content">
    <!-- Enhanced Form Panel -->
    <div class="form-panel">
      <div class="panel-header">
        <div class="panel-title">
          <span class="panel-icon">{{ editMode ? '✏️' : '➕' }}</span>
          <h2>{{ editMode ? 'Edit ATM Registry' : 'Add New ATM' }}</h2>
        </div>
        <div class="panel-status" *ngIf="editMode">
          <span class="status-badge editing">
            <span class="status-icon">✏️</span>
            Editing: {{ selectedAtmId }}
          </span>
        </div>
      </div>

      <!-- Edit Mode Indicator -->
      <div class="edit-mode-indicator" *ngIf="isEditFromRoute">
        <div class="edit-banner">
          <div class="edit-info">
            <span class="edit-icon">✏️</span>
            <div class="edit-text">
              <div class="edit-title">Editing ATM: {{ selectedAtmId }}</div>
              <div class="edit-subtitle">Make your changes and click "Update ATM" to save</div>
            </div>
          </div>
          <button class="btn btn-outline btn-sm" (click)="goBackToRegistry()">
            <span class="btn-icon">🔙</span>
            Back to Registry
          </button>
        </div>
      </div>

      <!-- Loading state for edit mode -->
      <div *ngIf="loadingEditAtm" class="loading-edit">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading ATM data for editing...</div>
        </div>
      </div>

      <form [formGroup]="atmForm" (ngSubmit)="onSubmit()" class="enhanced-form" *ngIf="!loadingEditAtm">
        <!-- Basic Information Section -->
        <div class="form-section">
          <div class="section-header">
            <span class="section-icon">🏛️</span>
            <h3>Basic Information</h3>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="atmId">ATM ID *</label>
              <input
                id="atmId"
                type="text"
                formControlName="atmId"
                [class.error]="atmForm.get('atmId')?.invalid && atmForm.get('atmId')?.touched"
                placeholder="Enter unique ATM identifier">
              <div class="error-message" *ngIf="atmForm.get('atmId')?.invalid && atmForm.get('atmId')?.touched">
                ATM ID is required
              </div>
            </div>

            <div class="form-group">
              <label for="serialNumber">Serial Number *</label>
              <input
                id="serialNumber"
                type="text"
                formControlName="serialNumber"
                [class.error]="atmForm.get('serialNumber')?.invalid && atmForm.get('serialNumber')?.touched"
                placeholder="Enter serial number">
              <div class="error-message" *ngIf="atmForm.get('serialNumber')?.invalid && atmForm.get('serialNumber')?.touched">
                Serial Number is required
              </div>
            </div>

            <div class="form-group">
              <label for="brand">Brand *</label>
              <input
                id="brand"
                type="text"
                formControlName="brand"
                [class.error]="atmForm.get('brand')?.invalid && atmForm.get('brand')?.touched"
                placeholder="e.g., NCR, Diebold">
              <div class="error-message" *ngIf="atmForm.get('brand')?.invalid && atmForm.get('brand')?.touched">
                Brand is required
              </div>
            </div>

            <div class="form-group">
              <label for="model">Model *</label>
              <input
                id="model"
                type="text"
                formControlName="model"
                [class.error]="atmForm.get('model')?.invalid && atmForm.get('model')?.touched"
                placeholder="e.g., SelfServ 88">
              <div class="error-message" *ngIf="atmForm.get('model')?.invalid && atmForm.get('model')?.touched">
                Model is required
              </div>
            </div>

            <div class="form-group">
              <label for="label">Display Label</label>
              <input
                id="label"
                type="text"
                formControlName="label"
                placeholder="Optional friendly name">
            </div>

            <div class="form-group">
              <label for="agencyCode">Agency *</label>
              <select
                id="agencyCode"
                formControlName="agencyCode"
                [class.error]="atmForm.get('agencyCode')?.invalid && atmForm.get('agencyCode')?.touched">
                <option value="">Select an agency</option>
                <option *ngFor="let agency of agencies" [value]="agency.agencyCode">
                  {{ agency.agencyName }} ({{ agency.agencyCode }})
                </option>
              </select>
              <div class="error-message" *ngIf="atmForm.get('agencyCode')?.invalid && atmForm.get('agencyCode')?.touched">
                Agency selection is required
              </div>
            </div>
          </div>
        </div>

        <!-- Network & System Section -->
        <div class="form-section">
          <div class="section-header">
            <span class="section-icon">🌐</span>
            <h3>Network & System</h3>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="ipAddress">IP Address</label>
              <input
                id="ipAddress"
                type="text"
                formControlName="ipAddress"
                [class.error]="atmForm.get('ipAddress')?.invalid && atmForm.get('ipAddress')?.touched"
                placeholder="192.168.1.100">
              <div class="error-message" *ngIf="atmForm.get('ipAddress')?.invalid && atmForm.get('ipAddress')?.touched">
                Please enter a valid IP address
              </div>
            </div>

            <div class="form-group">
              <label for="region">Region</label>
              <input
                id="region"
                type="text"
                formControlName="region"
                placeholder="e.g., North America, Europe">
            </div>
          </div>
        </div>

        <!-- Location Section -->
        <div class="form-section">
          <div class="section-header">
            <span class="section-icon">📍</span>
            <h3>Location Information</h3>
          </div>

          <div class="form-grid">
            <div class="form-group full-width">
              <label for="locationAddress">Address</label>
              <input
                id="locationAddress"
                type="text"
                formControlName="locationAddress"
                placeholder="Street address, city, state/province">
            </div>

            <div class="form-group">
              <label for="locationLatitude">Latitude</label>
              <input
                id="locationLatitude"
                type="number"
                step="any"
                formControlName="locationLatitude"
                [class.error]="atmForm.get('locationLatitude')?.invalid && atmForm.get('locationLatitude')?.touched"
                placeholder="40.7128">
              <div class="error-message" *ngIf="atmForm.get('locationLatitude')?.invalid && atmForm.get('locationLatitude')?.touched">
                Latitude must be between -90 and 90
              </div>
            </div>

            <div class="form-group">
              <label for="locationLongitude">Longitude</label>
              <input
                id="locationLongitude"
                type="number"
                step="any"
                formControlName="locationLongitude"
                [class.error]="atmForm.get('locationLongitude')?.invalid && atmForm.get('locationLongitude')?.touched"
                placeholder="-74.0060">
              <div class="error-message" *ngIf="atmForm.get('locationLongitude')?.invalid && atmForm.get('locationLongitude')?.touched">
                Longitude must be between -180 and 180
              </div>
            </div>
          </div>

          <!-- Location Helper Actions -->
          <div class="location-actions" *ngIf="hasCoordinates() || atmForm.get('locationLatitude')?.value || atmForm.get('locationLongitude')?.value">
            <button type="button" class="btn btn-sm btn-outline" (click)="previewLocation()" *ngIf="hasCoordinates()">
              <span class="btn-icon">🗺️</span>
              Preview on Map
            </button>
            <button type="button" class="btn btn-sm btn-outline" (click)="getCurrentLocation()">
              <span class="btn-icon">📍</span>
              Use Current Location
            </button>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="atmForm.invalid || isSubmitting">
            <span class="btn-icon" [ngClass]="{'spinning': isSubmitting}">
              {{ isSubmitting ? '🔄' : (editMode ? '💾' : '➕') }}
            </span>
            {{ isSubmitting ? 'Processing...' : (editMode ? 'Update ATM' : 'Add ATM') }}
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="resetForm()"
            [disabled]="isSubmitting">
            <span class="btn-icon">{{ isEditFromRoute ? '🔙' : '🔄' }}</span>
            {{ isEditFromRoute ? 'Cancel & Go Back' : (editMode ? 'Cancel Edit' : 'Reset Form') }}
          </button>
        </div>
      </form>
    </div>

    <!-- Enhanced Data Panel -->
    <div class="data-panel">
      <div class="panel-header">
        <div class="panel-title">
          <span class="panel-icon">📋</span>
          <h2>ATM Registry</h2>
          <span class="record-count">({{ atms.length }} ATMs)</span>
        </div>
        <div class="panel-controls">
          <button class="btn btn-sm btn-outline" (click)="refreshAtms()" [disabled]="loading">
            <span class="btn-icon" [ngClass]="{'spinning': loading}">🔄</span>
            Refresh
          </button>
          <button class="btn btn-sm btn-outline" (click)="exportData()">
            <span class="btn-icon">📤</span>
            Export
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading && !isEditFromRoute" class="loading-state">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading ATM registry data...</div>
        </div>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="error-state">
        <div class="error-content">
          <div class="error-icon">❌</div>
          <h3>Failed to Load ATM Registry</h3>
          <p>Unable to retrieve ATM data. Please check your connection and try again.</p>
          <button class="btn btn-primary" (click)="refreshAtms()">
            <span class="btn-icon">🔄</span>
            Retry
          </button>
        </div>
      </div>

      <!-- Data Table -->
      <div *ngIf="!loading && !error" class="table-container">
        <table class="data-table">
          <thead>
          <tr>
            <th>
              <div class="th-content">
                <span class="th-icon">🏛️</span>
                ATM ID
              </div>
            </th>
            <th>
              <div class="th-content">
                <span class="th-icon">🏷️</span>
                Label / Brand
              </div>
            </th>
            <th>
              <div class="th-content">
                <span class="th-icon">🏢</span>
                Agency
              </div>
            </th>
            <th>
              <div class="th-content">
                <span class="th-icon">📍</span>
                Location
              </div>
            </th>
            <th>
              <div class="th-content">
                <span class="th-icon">⚙️</span>
                Actions
              </div>
            </th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let atm of atms; trackBy: trackByAtmId"
              [class.editing]="selectedAtmId === atm.atmId">
            <td>
              <div class="cell-content primary">
                <span class="cell-icon">🏛️</span>
                <span class="cell-text">{{ atm.atmId }}</span>
              </div>
            </td>
            <td>
              <div class="cell-content">
                <div class="atm-info">
                  <div class="atm-label">{{ atm.label || atm.atmId }}</div>
                  <div class="atm-brand">{{ atm.brand }} {{ atm.model }}</div>
                  <div class="atm-serial" *ngIf="atm.serialNumber">S/N: {{ atm.serialNumber }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="cell-content">
                <div class="agency-info">
                  <div class="agency-name">{{ getAgencyName(atm.agencyCode) }}</div>
                  <div class="agency-code">{{ atm.agencyCode }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="cell-content">
                <div class="location-info">
                  <div class="location-address" *ngIf="atm.locationAddress">
                    <span class="location-icon">📍</span>
                    {{ atm.locationAddress }}
                  </div>
                  <div class="location-region" *ngIf="atm.region">
                    <span class="location-icon">🌍</span>
                    {{ atm.region }}
                  </div>
                  <div class="location-ip" *ngIf="atm.ipAddress">
                    <span class="location-icon">🌐</span>
                    {{ atm.ipAddress }}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <div class="cell-actions">
                <button
                  class="action-btn edit"
                  (click)="editAtm(atm)"
                  title="Edit ATM">
                  ✏️
                </button>
                <button
                  class="action-btn view"
                  (click)="viewAtm(atm)"
                  title="View Details">
                  👁️
                </button>
                <button
                  class="action-btn delete"
                  (click)="deleteAtm(atm.atmId)"
                  title="Delete ATM">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="atms.length === 0" class="no-data-row">
            <td colspan="5">
              <div class="no-data">
                <div class="no-data-icon">📭</div>
                <div class="no-data-text">No ATMs registered yet</div>
                <div class="no-data-subtitle">Add your first ATM using the form above</div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Processing Overlay -->
  <div *ngIf="isSubmitting" class="processing-overlay">
    <div class="processing-content">
      <div class="processing-spinner"></div>
      <div class="processing-text">{{ editMode ? 'Updating ATM...' : 'Creating ATM...' }}</div>
    </div>
  </div>
</div>
