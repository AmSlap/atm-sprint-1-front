<div class="dashboard-container">
  <div class="dashboard-content">
    <!-- Enhanced Header Section -->
    <div class="dashboard-header">
      <div class="title-section">
        <h1>ATM Monitoring Dashboard</h1>
        <div class="subtitle">
          <span>Welcome back</span>
          <span class="user-info">&#64;AmSlap</span>
          <span>‚Ä¢</span>
          <span>{{ getCurrentDateTime() }}</span>
        </div>
      </div>
      <div class="header-actions">
        <!-- Auto-refresh controls -->
        <div class="refresh-controls">
          <div class="auto-refresh-toggle">
            <label class="toggle-switch">
              <input type="checkbox"
                     [(ngModel)]="autoRefreshEnabled"
                     (change)="toggleAutoRefresh()">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Auto-refresh</span>
          </div>
          <select class="refresh-interval"
                  [(ngModel)]="refreshInterval"
                  (change)="updateRefreshInterval(refreshInterval)">
            <option value="10">10s</option>
            <option value="30">30s</option>
            <option value="60">1m</option>
            <option value="300">5m</option>
          </select>
        </div>

        <div class="last-updated" *ngIf="!loading">
          <div>Last refresh</div>
          <div>{{ getLastRefreshTime() }}</div>
          <div class="refresh-status"
               [ngClass]="{'auto-active': autoRefreshEnabled}">
            {{ autoRefreshEnabled ? 'Auto' : 'Manual' }}
          </div>
        </div>

        <button class="btn btn-outline"
                (click)="loadAtms()"
                [disabled]="loading">
          <span class="btn-icon" [ngClass]="{'spinning': loading}">üîÑ</span>
          {{ loading ? 'Refreshing...' : 'Refresh' }}
        </button>

        <a routerLink="/admin/registry" class="btn btn-primary">
          <span>‚öôÔ∏è</span>
          Admin Panel
        </a>
      </div>
    </div>

    <!-- Enhanced Stats Overview -->
    <div class="stats-overview" *ngIf="!loading && !error">
      <div class="stat-card stat-healthy" (click)="filterByHealthStatus('healthy')">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">{{ getHealthyCount() }}</div>
        <div class="stat-label">Healthy ATMs</div>
        <div class="stat-change positive" *ngIf="getHealthyCount() > 0">+{{ getHealthyCount() }}</div>
      </div>

      <div class="stat-card stat-warning" (click)="filterByHealthStatus('warning')">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-value">{{ getWarningCount() }}</div>
        <div class="stat-label">Need Attention</div>
        <div class="stat-change warning" *ngIf="getWarningCount() > 0">{{ getWarningCount() }}</div>
      </div>

      <div class="stat-card stat-error" (click)="filterByHealthStatus('error')">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-value">{{ getErrorCount() }}</div>
        <div class="stat-label">Critical Issues</div>
        <div class="stat-change negative" *ngIf="getErrorCount() > 0">{{ getErrorCount() }}</div>
      </div>

      <div class="stat-card stat-cash" (click)="filterByLowCash()">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value">{{ getLowCashCount() }}</div>
        <div class="stat-label">Low Cash</div>
        <div class="stat-change" [ngClass]="{'negative': getLowCashCount() > 0}">
          {{ getLowCashCount() > 0 ? getLowCashCount() : '0' }}
        </div>
      </div>

      <!-- Additional stats -->
      <div class="stat-card stat-info">
        <div class="stat-icon">üìç</div>
        <div class="stat-value">{{ regions.length }}</div>
        <div class="stat-label">Regions</div>
      </div>

      <div class="stat-card stat-info">
        <div class="stat-icon">üè¢</div>
        <div class="stat-value">{{ agencies.length }}</div>
        <div class="stat-label">Agencies</div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Loading ATM data...</p>
        <div class="loading-details">
          <span>Fetching real-time status...</span>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <div class="error-content">
        <div class="error-icon">üö´</div>
        <h2>Unable to Load Data</h2>
        <p>Connection error or service unavailable</p>
        <div class="error-details">
          <span>Check your network connection and backend services</span>
        </div>
        <div class="error-actions">
          <button class="btn btn-primary" (click)="loadAtms()">
            <span>üîÑ</span>
            Retry
          </button>
          <button class="btn btn-secondary" (click)="loadAtms()">
            <span>üìû</span>
            Contact Support
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced Filter Section -->
    <div class="filter-section" *ngIf="!loading && !error">
      <div class="filter-header">
        <h2>Filter & Search</h2>
        <div class="view-controls">
          <div class="view-toggle">
            <button class="view-btn"
                    [ngClass]="{'active': viewMode === 'grid'}"
                    (click)="viewMode = 'grid'">
              <span>‚äû</span>
              Grid
            </button>
            <button class="view-btn"
                    [ngClass]="{'active': viewMode === 'table'}"
                    (click)="viewMode = 'table'">
              <span>‚ò∞</span>
              Table
            </button>
          </div>
          <button class="btn btn-secondary btn-sm" (click)="exportToCSV()">
            <span>üìä</span>
            Export CSV
          </button>
        </div>
      </div>

      <div class="filter-grid">
        <div class="form-group search-group">
          <label for="search">Search ATMs</label>
          <div class="search-input-wrapper">
            <input
              type="text"
              id="search"
              placeholder="Search by ID, label, address, or agency..."
              [(ngModel)]="searchTerm"
              (input)="applyFilters()"
              class="search-input">
            <span class="search-icon">üîç</span>
            <button *ngIf="searchTerm"
                    class="clear-search"
                    (click)="searchTerm = ''; applyFilters()">
              ‚úñ
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="status">Operational Status</label>
          <select id="status" [(ngModel)]="selectedStatus" (change)="applyFilters()" class="filter-select">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="online">Online</option>
            <option value="offline">Offline</option>
            <option value="maintenance">Maintenance</option>
          </select>
        </div>

        <div class="form-group">
          <label for="health">Health Status</label>
          <select id="health" [(ngModel)]="selectedHealth" (change)="applyFilters()" class="filter-select">
            <option value="all">All Health Levels</option>
            <option value="ok">Healthy (OK)</option>
            <option value="green">Healthy (Green)</option>
            <option value="warning">Warning</option>
            <option value="orange">Warning (Orange)</option>
            <option value="error">Critical</option>
            <option value="red">Critical (Red)</option>
          </select>
        </div>

        <div class="form-group" *ngIf="regions.length > 0">
          <label for="region">Region</label>
          <select id="region" [(ngModel)]="selectedRegion" (change)="applyFilters()" class="filter-select">
            <option value="all">All Regions</option>
            <option *ngFor="let region of regions" [value]="region">{{ region }}</option>
          </select>
        </div>

        <div class="form-group" *ngIf="agencies.length > 0">
          <label for="agency">Agency</label>
          <select id="agency" [(ngModel)]="selectedAgency" (change)="applyFilters()" class="filter-select">
            <option value="all">All Agencies</option>
            <option *ngFor="let agency of agencies" [value]="agency.agencyCode">
              {{ agency.agencyName }}
            </option>
          </select>
        </div>

        <!-- Quick filter buttons -->
        <div class="form-group quick-filters">
          <label>Quick Filters</label>
          <div class="quick-filter-buttons">
            <button class="quick-filter-btn healthy"
                    (click)="filterByHealthStatus('healthy')">
              ‚úÖ Healthy
            </button>
            <button class="quick-filter-btn warning"
                    (click)="filterByHealthStatus('warning')">
              ‚ö†Ô∏è Warning
            </button>
            <button class="quick-filter-btn error"
                    (click)="filterByHealthStatus('error')">
              ‚ùå Critical
            </button>
            <button class="quick-filter-btn cash"
                    (click)="filterByLowCash()">
              üí∞ Low Cash
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Filter Summary -->
      <div class="filter-summary">
        <div class="results-info">
          <div class="results-count">
            Showing <strong>{{ filteredAtms.length }}</strong> of <strong>{{ atms.length }}</strong> ATMs
          </div>
          <div class="active-filters" *ngIf="hasActiveFilters()">
            <span class="filter-tag" *ngIf="selectedStatus !== 'all'">
              Status: {{ selectedStatus }}
              <button (click)="selectedStatus = 'all'; applyFilters()">‚úñ</button>
            </span>
            <span class="filter-tag" *ngIf="selectedHealth !== 'all'">
              Health: {{ selectedHealth }}
              <button (click)="selectedHealth = 'all'; applyFilters()">‚úñ</button>
            </span>
            <span class="filter-tag" *ngIf="selectedRegion !== 'all'">
              Region: {{ selectedRegion }}
              <button (click)="selectedRegion = 'all'; applyFilters()">‚úñ</button>
            </span>
            <span class="filter-tag" *ngIf="searchTerm">
              Search: "{{ searchTerm }}"
              <button (click)="searchTerm = ''; applyFilters()">‚úñ</button>
            </span>
          </div>
        </div>
        <div class="filter-actions">
          <!-- Sorting controls -->
          <div class="sort-controls">
            <label>Sort by:</label>
            <select [(ngModel)]="sortBy" (change)="applySorting()" class="sort-select">
              <option value="atmId">ATM ID</option>
              <option value="health">Health Priority</option>
              <option value="lastUpdate">Last Update</option>
              <option value="agency">Agency</option>
            </select>
            <button class="sort-direction"
                    (click)="sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; applySorting()">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </button>
          </div>
          <button class="btn btn-secondary btn-sm" (click)="resetFilters()">
            <span>üîÑ</span>
            Clear All Filters
          </button>
        </div>
      </div>
    </div>

    <!-- ATM Grid View -->
    <div class="atm-grid" *ngIf="!loading && !error && viewMode === 'grid'">
      <div class="atm-card"
           *ngFor="let atm of filteredAtms; trackBy: trackByAtmId"
           [routerLink]="['/atm', atm.atmId]"
           [ngClass]="getStatusClass(atm)">

        <!-- Enhanced card header -->
        <div class="card-indicators">
          <div class="low-cash-indicator" *ngIf="atm.lowCashFlag">
            üí∞ LOW CASH
          </div>
          <div class="last-update-indicator"
               [ngClass]="{'outdated': isOutdated(atm.lastUpdateTimestamp)}">
            {{ getTimeAgo(atm.lastUpdateTimestamp) }}
          </div>
        </div>

        <div class="status-header">
          <div class="atm-title">
            <h3>{{ atm.atmId }}</h3>
            <div class="atm-label" *ngIf="atm.label">{{ atm.label }}</div>
            <div class="atm-ip" *ngIf="atm.ipAddress">{{ atm.ipAddress }}</div>
          </div>
          <div class="status-badges">
            <div class="status-badge" [ngClass]="getStatusClass(atm)">
              <span class="status-indicator" [ngClass]="getStatusClass(atm)"></span>
              {{ atm.operationalState }}
            </div>
            <div class="health-badge" [ngClass]="getHealthClass(atm)">
              {{ atm.overallHealth }}
            </div>
          </div>
        </div>

        <!-- Enhanced details section -->
        <div class="atm-details">
          <div class="detail-row" *ngIf="atm.brand && atm.model">
            <span class="label">
              <span class="icon">üèß</span>
              Device
            </span>
            <span class="value">{{ atm.brand }} {{ atm.model }}</span>
          </div>

          <div class="detail-row" *ngIf="atm.region">
            <span class="label">
              <span class="icon">üåç</span>
              Region
            </span>
            <span class="value">{{ atm.region }}</span>
          </div>

          <div class="detail-row" *ngIf="atm.agencyName">
            <span class="label">
              <span class="icon">üè¢</span>
              Agency
            </span>
            <span class="value">{{ atm.agencyName }}</span>
          </div>

          <div class="detail-row" *ngIf="atm.locationAddress">
            <span class="label">
              <span class="icon">üìç</span>
              Location
            </span>
            <span class="value">{{ atm.locationAddress }}</span>
          </div>
        </div>

        <!-- Card actions -->
        <div class="card-footer">
          <div class="footer-info">
            <div class="last-updated">
              Last updated: {{ atm.lastUpdateTimestamp | date:'MMM d, y, h:mm a' }}
            </div>
          </div>
          <div class="card-actions" (click)="$event.stopPropagation()">
            <button class="action-btn primary"
                    [routerLink]="['/atm', atm.atmId]"
                    title="View Details">
              üëÅÔ∏è
            </button>
            <button class="action-btn secondary"
                    (click)="refreshSingleAtm(atm.atmId)"
                    title="Refresh">
              üîÑ
            </button>
            <button class="action-btn secondary"
                    *ngIf="atm.locationLatitude && atm.locationLongitude"
                    title="View on Map">
              üó∫Ô∏è
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ATM Table View -->
    <div class="atm-table-container" *ngIf="!loading && !error && viewMode === 'table'">
      <table class="atm-table">
        <thead>
        <tr>
          <th (click)="setSortBy('atmId')" class="sortable">
            ATM ID
            <span class="sort-indicator" *ngIf="sortBy === 'atmId'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th>Status</th>
          <th (click)="setSortBy('health')" class="sortable">
            Health
            <span class="sort-indicator" *ngIf="sortBy === 'health'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="setSortBy('agency')" class="sortable">
            Agency
            <span class="sort-indicator" *ngIf="sortBy === 'agency'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th>Region</th>
          <th>Cash</th>
          <th (click)="setSortBy('lastUpdate')" class="sortable">
            Last Update
            <span class="sort-indicator" *ngIf="sortBy === 'lastUpdate'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let atm of filteredAtms; trackBy: trackByAtmId"
            [ngClass]="getStatusClass(atm)"
            (click)="navigateToAtmDetails(atm.atmId)">
          <td class="atm-id-cell">
            <div class="atm-id">{{ atm.atmId }}</div>
            <div class="atm-label" *ngIf="atm.label">{{ atm.label }}</div>
          </td>
          <td>
              <span class="status-badge-small" [ngClass]="getStatusClass(atm)">
                {{ atm.operationalState }}
              </span>
          </td>
          <td>
              <span class="health-badge-small" [ngClass]="getHealthClass(atm)">
                {{ atm.overallHealth }}
              </span>
          </td>
          <td>{{ atm.agencyName || '-' }}</td>
          <td>{{ atm.region || '-' }}</td>
          <td>
              <span class="cash-indicator" [ngClass]="{'low-cash': atm.lowCashFlag}">
                {{ atm.lowCashFlag ? 'üí∞ Low' : '‚úÖ OK' }}
              </span>
          </td>
          <td class="last-update-cell">
            <div class="update-time">{{ atm.lastUpdateTimestamp | date:'MMM d, h:mm a' }}</div>
            <div class="time-ago">{{ getTimeAgo(atm.lastUpdateTimestamp) }}</div>
          </td>
          <td class="actions-cell" (click)="$event.stopPropagation()">
            <button class="action-btn-small"
                    [routerLink]="['/atm', atm.atmId]"
                    title="View Details">
              üëÅÔ∏è
            </button>
            <button class="action-btn-small"
                    (click)="refreshSingleAtm(atm.atmId)"
                    title="Refresh">
              üîÑ
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && filteredAtms.length === 0" class="empty-state">
      <div class="empty-content">
        <div class="empty-icon">üîç</div>
        <h2>No ATMs Found</h2>
        <p>No ATMs match your current search criteria</p>
        <div class="empty-suggestions">
          <p>Try:</p>
          <ul>
            <li>Clearing your search filters</li>
            <li>Broadening your search terms</li>
            <li>Checking different regions or agencies</li>
          </ul>
        </div>
        <div class="empty-actions">
          <button class="btn btn-primary" (click)="resetFilters()">
            <span>üîÑ</span>
            Reset All Filters
          </button>
          <button class="btn btn-secondary" (click)="loadAtms()">
            <span>üì°</span>
            Refresh Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
